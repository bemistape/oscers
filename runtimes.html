<body>
  <!-- NAVIGATION BAR -->
  <nav id="navBar">
    <a href="index.html">Oscer Bingo</a>
    <a href="runtimes.html">Runtime Challenge</a>
    <a href="runtime_dream.html">Runtime Dream</a>
  </nav>

  <!-- INTRO SCREEN -->
  <div id="intro-container" class="page-container">
    <h1>Runtime Challenge</h1>
    <div class="intro-rules">
      <p>In this game, you'll be given 5 movies each round.</p>
      <p>Drag (or tap) the runtime card to the movie you think it belongs to.</p>
      <p>You have a limited time each round and can submit early for a time bonus.</p>
      <p>Use your <strong>Joker</strong> once at the start of the round.</p>
    </div>
    <!-- Input for player's name -->
    <input id="playerNameInput" type="text" placeholder="Enter 6-letter name" maxlength="6">
    <div class="difficulty-box">
      <label style="font-size:16px; margin-right:10px;">Difficulty:</label>
      <button class="diff-btn" data-difficulty="easy" id="easy-btn">Easy</button>
      <button class="diff-btn" data-difficulty="medium" id="medium-btn">Medium</button>
      <button class="diff-btn" data-difficulty="hard" id="hard-btn">Hard</button>
    </div>
    <button id="begin-btn" class="game-btn" disabled>Begin</button>
    <div class="version-number">v5.3</div>
  </div>

  <!-- ROUND RECAP OVERLAY -->
  <div id="round-recap-overlay">
    <h3 id="round-recap-title"></h3>
    <p id="round-recap-details"></p>
    <button id="round-recap-close-btn" class="game-btn" style="font-size:16px; padding:6px 12px;">OK</button>
  </div>

  <!-- REACTION OVERLAY -->
  <div id="reaction-overlay">
    <p id="reaction-quote"></p>
    <button id="reaction-close-btn" class="game-btn">OK</button>
  </div>

  <!-- GAME SCREEN -->
  <div id="game-container" class="page-container">
    <div id="timer-box">
      <div id="round-label">Round 1</div>
      <div id="timer-value">20</div>
      <button id="joker-btn" class="glow-anim" title="Reveal relative runtimes briefly">ü§°</button>
    </div>
    <div id="runtimes-container" class="cards-container"></div>
    <div id="movies-container" class="cards-container"></div>
    <button id="submit-btn" class="game-btn" title="Submit early to earn extra time bonus!">Submit</button>
    <div id="this-game-stats" class="stats-box empty"></div>
  </div>

  <!-- BONUS ROUND (Grid Layout) -->
  <div id="bonus-container" class="page-container">
    <div id="bonus-intro" style="max-width:600px; margin-bottom:20px;">
      <p><strong>Bonus Round!</strong> Pick which movie has the longest runtime for +1000 points. 
         You have a short time, so choose quickly!</p>
      <button id="bonus-begin-btn" class="game-btn">Begin Bonus</button>
    </div>
    <div id="bonus-timer-box" style="display:none;"><span id="bonus-timer-value">10</span></div>
    <h3 id="bonus-message"></h3>
    <div id="bonus-floating-container"></div>
    <button id="bonus-continue-btn" class="game-btn" style="display:none;">Continue</button>
    <div id="bonus-result"></div>
  </div>

  <!-- FINAL SCREEN -->
  <div id="final-container" class="page-container">
    <div id="final-scores"></div>
    <div id="final-overall-box"></div>
    <div class="final-buttons">
      <button id="share-twitter-btn" class="game-btn">Share on Twitter</button>
      <button id="copy-recap-btn" class="game-btn">Copy Recap</button>
      <button id="play-again-btn" class="game-btn">Play Again?</button>
      <button id="submit-score-btn" class="game-btn">Submit Score</button>
    </div>
    <div id="details-container">
      <div id="final-cards-container"></div>
    </div>
  </div>

  <script>
    /*******************************************************
     * GLOBAL STATE & CONFIG
     *******************************************************/
    const SCORE_URL = "YOUR_APPS_SCRIPT_URL";  // Replace with your actual script URL
    const csvUrl = "runtime_source_02222025.csv";
    const reactionsUrl = "reactions.csv";

    let difficulty;
    let allMovies = [];
    let filteredMovies = [];
    let perfectReactions = [];
    let closeReactions = [];
    let unimpressedReactions = [];
    let badReactions = [];

    const TIMERS = {
      easy:   [30, 30, 30, 30, 30],
      medium: [30, 25, 20, 15, 15],
      hard:   [20, 18, 15, 12, 10]
    };
    let roundTimers = [];
    let rounds = [];
    let currentRoundIndex = 0;

    let totalCorrect = 0;
    let totalDifference = 0;
    let totalAnswered = 0;
    let totalScore = 0;
    let roundScores = [];

    let jokerUsed = false;
    let timeLeft = 20;
    let roundTimer = null;
    let canDrag = false;

    let selectedRuntimeCard = null;  // For mobile tap-to-select
    let bonusMovies = [];
    let bonusUsed = false;
    let bonusTimer = null;
    let bonusTimeLeft = 10;
    let bonusStarted = false;

    let playerName = "";
    let pendingReaction = "";

    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("easy-btn").addEventListener("click", () => setDifficulty("easy"));
      document.getElementById("medium-btn").addEventListener("click", () => setDifficulty("medium"));
      document.getElementById("hard-btn").addEventListener("click", () => setDifficulty("hard"));
      setDifficulty("easy");

      const nameInput = document.getElementById("playerNameInput");
      nameInput.addEventListener("input", ()=>{
        document.getElementById("begin-btn").disabled = (nameInput.value.trim().length!==6);
      });

      const beginBtn = document.getElementById("begin-btn");
      beginBtn.disabled = true;
      beginBtn.innerText = "Loading...";

      try {
        await fetchMainCSV();
        await fetchReactionsCSV();
        beginBtn.disabled = false;
        beginBtn.innerText = "Begin";
      } catch(e) {
        console.error("Error loading data:", e);
        beginBtn.innerText = "Error loading data";
      }

      beginBtn.addEventListener("click", onBeginGame);

      document.getElementById("joker-btn").addEventListener("click", ()=>{
        if(!jokerUsed) useJoker();
      });
      document.getElementById("submit-btn").addEventListener("click", onSubmitRound);

      document.getElementById("bonus-begin-btn").addEventListener("click", startBonusActual);
      document.getElementById("bonus-continue-btn").addEventListener("click", onFinishBonus);

      document.getElementById("share-twitter-btn").addEventListener("click", shareOnTwitter);
      document.getElementById("copy-recap-btn").addEventListener("click", copyRecap);
      document.getElementById("play-again-btn").addEventListener("click",()=>{
        document.getElementById("final-container").style.display="none";
        document.getElementById("intro-container").style.display="flex";
      });

      // "Submit Score" on final screen
      document.getElementById("submit-score-btn").addEventListener("click",()=>{
        submitScore(playerName, new Date().toISOString(), totalScore, difficulty);
      });

      // Overlays: close either => close both
      document.getElementById("round-recap-close-btn").addEventListener("click",()=>{
        hideAllPopups();
        nextRoundAfterReaction();
      });
      document.getElementById("reaction-close-btn").addEventListener("click",()=>{
        hideAllPopups();
        nextRoundAfterReaction();
      });
    });

    function hideAllPopups(){
      document.getElementById("round-recap-overlay").style.display="none";
      document.getElementById("reaction-overlay").style.display="none";
    }

    /*******************************************************
     * CSV LOADING
     *******************************************************/
    async function fetchMainCSV(){
      const resp=await fetch(csvUrl);
      let data=await resp.text();
      data=data.replace(/^\uFEFF/,"");
      parseMainCSV(data);
    }
    function parseMainCSV(csvData){
      const lines=csvData.trim().split(/\r?\n/);
      const headers=lines[0].split(",");
      const colMovieName=headers.indexOf("movie_name");
      const colRuntime=headers.indexOf("runtime");
      const colDifficulty=headers.indexOf("difficulty");
      const colGroup=headers.indexOf("group");
      const colPoster=headers.indexOf("poster");
      const colOverview=headers.indexOf("overview");
      for(let i=1;i<lines.length;i++){
        const rowCells=lines[i].split(",");
        if(rowCells.length<6)continue;
        let movie={};
        movie.movie_name=rowCells[colMovieName]?.trim()||"";
        movie.runtime=parseInt(rowCells[colRuntime]||"0",10);
        movie.difficulty=rowCells[colDifficulty]?.trim().toLowerCase()||"";
        movie.group=rowCells[colGroup]?.trim().toUpperCase()||"";
        movie.poster=rowCells[colPoster]?.trim()||"";
        movie.overview=rowCells[colOverview]?.trim()||"";
        movie._assignedRuntime=null;
        allMovies.push(movie);
      }
    }
    async function fetchReactionsCSV(){
      const resp=await fetch(reactionsUrl);
      let data=await resp.text();
      data=data.replace(/^\uFEFF/,"");
      parseReactionsCSV(data);
    }
    function parseReactionsCSV(csvData){
      const rows=parseCSVWithQuotes(csvData);
      const headers=rows[0];
      const colPerfect=headers.indexOf("perfect");
      const colClose=headers.indexOf("close");
      const colUnimp=headers.indexOf("unimpressed");
      const colBad=headers.indexOf("bad");
      for(let i=1;i<rows.length;i++){
        const r=rows[i];
        if(r.length<4)continue;
        if(r[colPerfect])perfectReactions.push(r[colPerfect]);
        if(r[colClose])closeReactions.push(r[colClose]);
        if(r[colUnimp])unimpressedReactions.push(r[colUnimp]);
        if(r[colBad])badReactions.push(r[colBad]);
      }
    }
    function parseCSVWithQuotes(csv){
      const lines=[];
      let currentLine=[];
      let currentCell="";
      let inQuotes=false;
      for(let i=0;i<csv.length;i++){
        const c=csv[i];
        if(c==='"'){
          if(inQuotes&&csv[i+1]==='"'){
            currentCell+='"';i++;
          } else {
            inQuotes=!inQuotes;
          }
        } else if(c===','&&!inQuotes){
          currentLine.push(currentCell);
          currentCell="";
        } else if((c==='\r'||c==='\n')&&!inQuotes){
          if(c==='\r'&&i<csv.length-1&&csv[i+1]==='\n')i++;
          currentLine.push(currentCell);
          lines.push(currentLine);
          currentLine=[];
          currentCell="";
        } else {
          currentCell+=c;
        }
      }
      if(currentCell||currentLine.length>0){
        currentLine.push(currentCell);
        lines.push(currentLine);
      }
      return lines;
    }

    /*******************************************************
     * DIFFICULTY / SETUP
     *******************************************************/
    function setDifficulty(diff){
      difficulty=diff;
      ["easy-btn","medium-btn","hard-btn"].forEach(id=>{
        document.getElementById(id).classList.remove("active");
      });
      document.getElementById(diff+"-btn").classList.add("active");
    }
    function onBeginGame(){
      const nameInput=document.getElementById("playerNameInput");
      playerName=nameInput.value.trim();
      if(playerName.length!==6){
        alert("Please enter a 6-letter name.");
        return;
      }
      document.getElementById("intro-container").style.display="none";
      document.getElementById("game-container").style.display="flex";
      setupGame();
    }
    function setupGame(){
      currentRoundIndex=0;
      totalCorrect=0;
      totalDifference=0;
      totalAnswered=0;
      totalScore=0;
      roundScores=[];
      jokerUsed=false;
      bonusUsed=false;
      bonusStarted=false;
      selectedRuntimeCard=null;
      document.getElementById("bonus-container").style.display="none";
      document.getElementById("final-container").style.display="none";
      filterByDifficulty();
      if(filteredMovies.length<5){
        filteredMovies=allMovies.slice();
      }
      roundTimers=TIMERS[difficulty]||[20,20,20,20,20];
      buildRounds();
      startRound();
    }
    function filterByDifficulty(){
      if(!difficulty)return;
      filteredMovies=allMovies.filter(m=>m.difficulty===difficulty);
    }
    function buildRounds(){
      const groups={A:[],B:[],C:[],D:[],E:[]};
      filteredMovies.forEach(movie=>{
        if(groups[movie.group]!==undefined){
          groups[movie.group].push(movie);
        }
      });
      for(let g in groups){
        groups[g]=shuffle(groups[g]);
      }
      const potentialRoundsCount=Math.min(
        groups["A"].length,
        groups["B"].length,
        groups["C"].length,
        groups["D"].length,
        groups["E"].length
      );
      const finalCount=Math.min(potentialRoundsCount,5);
      rounds=[];
      for(let i=0;i<finalCount;i++){
        rounds.push([
          groups["A"][i],
          groups["B"][i],
          groups["C"][i],
          groups["D"][i],
          groups["E"][i]
        ]);
      }
      console.log("Rounds built:",rounds);
    }

    /*******************************************************
     * ROUND LOGIC
     *******************************************************/
    function startRound(){
      if(currentRoundIndex>=5){
        document.getElementById("game-container").style.display="none";
        document.getElementById("bonus-container").style.display="flex";
        document.getElementById("bonus-intro").style.display="block";
        document.getElementById("bonus-timer-box").style.display="none";
        document.getElementById("bonus-floating-container").style.display="none";
        document.getElementById("bonus-continue-btn").style.display="none";
        return;
      }
      fadeOutCards(()=>{
        renderRound();
        fadeInCards();
      });
    }
    function renderRound(){
      timeLeft=roundTimers[currentRoundIndex]||20;
      setupTimer();
      updateGameStatsBox();
      document.getElementById("round-label").innerText=`Round ${currentRoundIndex+1}`;
      const moviesContainer=document.getElementById("movies-container");
      const runtimesContainer=document.getElementById("runtimes-container");
      moviesContainer.innerHTML="";
      runtimesContainer.innerHTML="";
      document.getElementById("joker-btn").style.display=jokerUsed?"none":"inline-block";
      const roundMovies=rounds[currentRoundIndex];
      const displayMovies=shuffle([...roundMovies]);
      displayMovies.forEach(m=>{
        const card=document.createElement("div");
        card.classList.add("movie-card");
        card.setAttribute("data-correct",m.runtime);
        card.movie=m;
        let posterHTML=m.poster?`<img class="movie-poster" src="${m.poster}" alt="${m.movie_name} poster">`:"";
        card.innerHTML=posterHTML;
        card.addEventListener("click",()=>{
          if(selectedRuntimeCard && !card.querySelector(".runtime-card")){
            card.appendChild(selectedRuntimeCard);
            card.classList.add("placed");
            m._assignedRuntime=parseInt(selectedRuntimeCard.getAttribute("data-runtime"),10);
            selectedRuntimeCard.classList.remove("selected");
            selectedRuntimeCard=null;
          }
        });
        card.addEventListener("dragover",e=>{if(canDrag)e.preventDefault();});
        card.addEventListener("drop",e=>dropHandler(e,m,card));
        moviesContainer.appendChild(card);
      });
      roundMovies.forEach((m,i)=>{
        const rc=document.createElement("div");
        rc.classList.add("runtime-card");
        rc.setAttribute("data-unique",`rt-${currentRoundIndex}-${i}`);
        rc.setAttribute("data-runtime",m.runtime.toString());
        rc.innerText=m.runtime+" min";
        rc.setAttribute("draggable","true");
        rc.addEventListener("dragstart",e=>{
          if(!canDrag){e.preventDefault();return;}
          rc.classList.add("dragging");
          e.dataTransfer.setData("text/plain",rc.getAttribute("data-unique"));
        });
        rc.addEventListener("dragend",()=>{
          rc.classList.remove("dragging");
        });
        rc.addEventListener("click",()=>{
          if(selectedRuntimeCard===rc){
            rc.classList.remove("selected");
            selectedRuntimeCard=null;
          } else {
            if(selectedRuntimeCard)selectedRuntimeCard.classList.remove("selected");
            selectedRuntimeCard=rc;
            rc.classList.add("selected");
          }
        });
        runtimesContainer.appendChild(rc);
      });
      canDrag=true;
    }
    function setupTimer(){
      clearInterval(roundTimer);
      styleTimerBox(timeLeft);
      const timerVal=document.getElementById("timer-value");
      timerVal.innerText=timeLeft;
      roundTimer=setInterval(()=>{
        timeLeft--;
        timerVal.innerText=timeLeft;
        styleTimerBox(timeLeft);
        if(timeLeft<=0){
          clearInterval(roundTimer);
          onSubmitRound();
        }
      },1000);
    }
    function styleTimerBox(t){
      const timerBox=document.getElementById("timer-box");
      if(t<=3){
        timerBox.style.color="red";
        timerBox.style.borderColor="red";
      } else if(t<=5){
        timerBox.style.color="orange";
        timerBox.style.borderColor="orange";
      } else if(t<=10){
        timerBox.style.color="yellow";
        timerBox.style.borderColor="yellow";
      } else {
        timerBox.style.color="white";
        timerBox.style.borderColor="#444";
      }
    }
    function dropHandler(e,movieObj,movieCard){
      if(!canDrag)return;
      e.preventDefault();
      const uniqueId=e.dataTransfer.getData("text/plain");
      const dragged=document.querySelector(`.runtime-card[data-unique="${uniqueId}"]`);
      if(!dragged)return;
      const rc=document.getElementById("runtimes-container");
      const existing=movieCard.querySelector(".runtime-card");
      if(existing)rc.appendChild(existing);
      movieCard.appendChild(dragged);
      movieCard.classList.add("placed");
      movieObj._assignedRuntime=parseInt(dragged.getAttribute("data-runtime"),10);
    }
    function onSubmitRound(){
      clearInterval(roundTimer);
      canDrag=false;
      document.getElementById("submit-btn").style.display="none";
      const roundMovies=rounds[currentRoundIndex];
      let roundCorrect=0,roundDiff=0,answeredCount=0,sumActual=0;
      const cards=document.getElementById("movies-container").children;
      for(let i=0;i<cards.length;i++){
        const card=cards[i];
        const correctRuntime=parseInt(card.getAttribute("data-correct"),10);
        sumActual+=correctRuntime;
        const assigned=card.querySelector(".runtime-card");
        if(assigned){
          answeredCount++;
          const userRuntime=parseInt(assigned.getAttribute("data-runtime"),10);
          if(userRuntime===correctRuntime){
            roundCorrect++;
            card.classList.add("correct");
          } else {
            card.classList.add("incorrect");
            showCorrectLine(card,correctRuntime);
          }
        } else {
          card.classList.add("incorrect");
          showCorrectLine(card,correctRuntime);
        }
      }
      const leftoverBonus=timeLeft*10;
      roundMovies.forEach(m=>{
        if(m._assignedRuntime!=null){
          roundDiff+=Math.abs(m._assignedRuntime-m.runtime);
        }
      });
      let fractionBonus=0;
      if(answeredCount===5){
        const avgActual=sumActual/5;
        const avgDiff=roundDiff/answeredCount;
        const fraction=avgDiff/avgActual;
        fractionBonus=(1000*roundCorrect)*Math.pow((1-fraction),2);
      }
      const baseScore=roundCorrect*1000;
      const roundScore=baseScore+leftoverBonus+fractionBonus;
      totalCorrect+=roundCorrect;
      totalDifference+=roundDiff;
      totalAnswered+=answeredCount;
      totalScore+=roundScore;
      roundScores.push({
        roundIndex: currentRoundIndex+1,
        correct:roundCorrect,
        diff:roundDiff,
        answered:answeredCount,
        leftoverBonus,
        fractionBonus,
        roundScore
      });
      // pick reaction
      if(roundCorrect===5){
        pendingReaction=randomFrom(perfectReactions);
      } else if(roundCorrect===4){
        pendingReaction=randomFrom(closeReactions);
      } else if(roundCorrect===3||roundCorrect===2){
        pendingReaction=randomFrom(unimpressedReactions);
      } else {
        pendingReaction=randomFrom(badReactions);
      }
      showRoundRecapOverlay(roundCorrect,answeredCount,leftoverBonus,fractionBonus,roundScore);
      // Reaction is shown simultaneously, so just do:
      showReactionOverlay(pendingReaction);
    }
    function showCorrectLine(card,correctRuntime){
      const line=document.createElement("div");
      line.style.fontSize="12px";
      line.style.marginTop="5px";
      line.innerText=`Correct: ${correctRuntime} min`;
      card.appendChild(line);
    }
    function showRoundRecapOverlay(roundCorrect,answeredCount,leftoverBonus,fractionBonus,roundScore){
      const overlay=document.getElementById("round-recap-overlay");
      const title=document.getElementById("round-recap-title");
      const details=document.getElementById("round-recap-details");
      title.innerText=`Round ${currentRoundIndex+1} Recap`;
      details.innerHTML=`
        Correct: <strong>${roundCorrect}</strong> / 5<br>
        Time bonus: <strong>+${leftoverBonus.toFixed(0)}</strong><br>
        Accuracy bonus: <strong>+${fractionBonus.toFixed(0)}</strong><br>
        Round Score: <strong>${roundScore.toFixed(0)}</strong>
      `;
      overlay.style.display="block";
    }
    function showReactionOverlay(quoteText){
      const overlay=document.getElementById("reaction-overlay");
      document.getElementById("reaction-quote").innerText=quoteText;
      overlay.style.display="block";
    }
    function nextRoundAfterReaction(){
      hideAllPopups();
      document.getElementById("submit-btn").style.display="block";
      currentRoundIndex++;
      startRound();
    }

    /*******************************************************
     * JOKER
     *******************************************************/
    function useJoker(){
      if(jokerUsed)return;
      jokerUsed=true;
      document.getElementById("joker-btn").style.display="none";
      const snd=document.getElementById("joker-sound");
      snd.currentTime=0;
      snd.play().catch(()=>{});
      const roundMovies=rounds[currentRoundIndex];
      // We'll do a flexible find so if CSV says "The Rock" but alt says "The Rock (1996)",
      // it tries to ignore trailing year in parentheses.
      const sorted=[...roundMovies].sort((a,b)=>b.runtime-a.runtime);
      const greenShades=["#003300","#006600","#009900","#00CC00","#00FF00"];
      const originals=[];
      sorted.forEach((m,idx)=>{
        const card=findMovieCard(m.movie_name);
        if(!card)return;
        originals.push({card,bg:card.style.backgroundColor,bc:card.style.borderColor});
        card.style.backgroundColor=greenShades[idx];
        card.style.borderColor=greenShades[idx];
      });
      setTimeout(()=>{
        originals.forEach(o=>{
          o.card.style.backgroundColor="#000";
          o.card.style.borderColor="white";
        });
      },5000);
    }

    /*******************************************************
     * BONUS ROUND
     *******************************************************/
    function startBonusActual(){
      if(bonusStarted)return;
      bonusStarted=true;
      document.getElementById("bonus-intro").style.display="none";
      document.getElementById("bonus-timer-box").style.display="flex";
      document.getElementById("bonus-floating-container").style.display="grid";
      document.getElementById("bonus-continue-btn").style.display="none";
      startBonusRound();
    }
    function startBonusRound(){
      bonusUsed=false;
      bonusTimeLeft=10;
      let pool=shuffle(filteredMovies.slice());
      if(pool.length<5)pool=allMovies.slice();
      bonusMovies=pool.slice(0,5);
      const container=document.getElementById("bonus-floating-container");
      container.innerHTML="";
      bonusMovies.forEach(m=>{
        const card=document.createElement("div");
        card.classList.add("floating-card");
        if(m.poster){
          const img=document.createElement("img");
          img.src=m.poster;
          img.classList.add("bonus-poster");
          card.appendChild(img);
        }
        const runtimeLine=document.createElement("div");
        runtimeLine.classList.add("bonus-runtime");
        runtimeLine.innerText=`${m.runtime} min`;
        card.appendChild(runtimeLine);
        card.addEventListener("click",()=>pickBonusMovie(m,card));
        container.appendChild(card);
      });
      setupBonusTimer();
      document.getElementById("bonus-message").innerText="";
      document.getElementById("bonus-result").innerText="";
    }
    function setupBonusTimer(){
      clearInterval(bonusTimer);
      const box=document.getElementById("bonus-timer-box");
      const val=document.getElementById("bonus-timer-value");
      val.innerText=bonusTimeLeft;
      box.style.color="white";
      box.style.borderColor="#444";
      bonusTimer=setInterval(()=>{
        bonusTimeLeft--;
        val.innerText=bonusTimeLeft;
        if(bonusTimeLeft<=3){
          box.style.color="red";
          box.style.borderColor="red";
        } else if(bonusTimeLeft<=5){
          box.style.color="orange";
          box.style.borderColor="orange";
        }
        if(bonusTimeLeft<=0){
          clearInterval(bonusTimer);
          if(!bonusUsed){
            document.getElementById("bonus-message").innerText="Time's up! No pick made.";
            document.getElementById("bonus-continue-btn").style.display="inline-block";
          }
        }
      },1000);
    }
    function pickBonusMovie(chosenMovie,chosenCard){
      if(bonusUsed)return;
      bonusUsed=true;
      clearInterval(bonusTimer);
      let maxRuntime=-1,maxMovie=null;
      bonusMovies.forEach(m=>{
        if(m.runtime>maxRuntime){
          maxRuntime=m.runtime;
          maxMovie=m;
        }
      });
      const correct=(chosenMovie.runtime===maxRuntime);
      chosenCard.classList.add(correct?"correct":"incorrect");
      if(correct){
        totalScore+=1000;
        document.getElementById("bonus-message").innerText="Correct! +1000 points.";
      } else {
        document.getElementById("bonus-message").innerText=`Sorry, it was ${maxMovie.movie_name} (${maxRuntime} min).`;
      }
      const allCards=document.querySelectorAll("#bonus-floating-container .floating-card");
      allCards.forEach(c=>{
        const rt=c.querySelector(".bonus-runtime");
        if(rt)rt.style.display="block";
      });
      document.getElementById("bonus-continue-btn").style.display="inline-block";
    }
    function onFinishBonus(){
      document.getElementById("bonus-container").style.display="none";
      showFinalScreen();
    }

    /*******************************************************
     * FINAL SCREEN
     *******************************************************/
    function showFinalScreen(){
      document.getElementById("final-container").style.display="flex";
      const accuracy=(totalCorrect/25)*100;
      const skill=totalAnswered?(totalDifference/totalAnswered):0;
      document.getElementById("final-scores").innerText=`Final Score: ${Math.round(totalScore)}`;
      const overallBox=document.getElementById("final-overall-box");
      overallBox.innerHTML=`Accuracy: ${accuracy.toFixed(1)}% | Skill: ${skill.toFixed(1)} min`;

      const finalCardsContainer=document.getElementById("final-cards-container");
      finalCardsContainer.innerHTML="";
      rounds.forEach((round,idx)=>{
        const wrapper=document.createElement("div");
        wrapper.classList.add("final-round-wrapper");
        const heading=document.createElement("div");
        heading.classList.add("final-round-heading");
        heading.innerText=`Round ${idx+1}`;
        wrapper.appendChild(heading);

        const rowDiv=document.createElement("div");
        rowDiv.classList.add("final-round-row");
        round.forEach(movie=>{
          const actual=movie.runtime;
          const assigned=(movie._assignedRuntime!==null)?movie._assignedRuntime:"-";
          const isCorrect=(assigned===actual);
          const card=document.createElement("div");
          card.classList.add("final-card");
          if(assigned!=="-"){
            card.classList.add(isCorrect?"correct":"incorrect");
          }
          let posterHTML=movie.poster?`<img class="movie-poster" src="${movie.poster}" alt="${movie.movie_name} poster">`:"";
          card.innerHTML=`
            ${posterHTML}
            <div class="movie-title">${movie.movie_name}</div>
            <div>Actual: ${movie.runtime} min</div>
            <div>Your Pick: ${assigned==="-"?"-":assigned+" min"}</div>
          `;
          rowDiv.appendChild(card);
        });
        wrapper.appendChild(rowDiv);

        const roundInfo=roundScores[idx];
        if(roundInfo){
          const infoDiv=document.createElement("div");
          infoDiv.classList.add("round-breakdown-info");
          infoDiv.innerHTML=`
            ${roundInfo.correct}/5 correct<br>
            Time bonus: +${(roundInfo.leftoverBonus||0).toFixed(0)}<br>
            Accuracy bonus: +${(roundInfo.fractionBonus||0).toFixed(0)}<br>
            Round Score: ${roundInfo.roundScore.toFixed(0)}
          `;
          wrapper.appendChild(infoDiv);
        }
        finalCardsContainer.appendChild(wrapper);
      });
    }

    /*******************************************************
     * SCORE SUBMISSION
     *******************************************************/
    function submitScore(name, timestamp, score, difficulty){
      if(!difficulty) difficulty="unknown";
      const data={name, timestamp, score, difficulty};
      fetch(SCORE_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(data)
      })
      .then(resp=>resp.json())
      .then(result=>{
        console.log("Score submitted:",result);
        alert("Score submitted successfully!");
      })
      .catch(err=>{
        console.error("Error submitting score:",err);
        alert("Error submitting score. Check console for details.");
      });
    }

    /*******************************************************
     * SHARE & COPY
     *******************************************************/
    function shareOnTwitter(){
      const accuracy=(totalCorrect/25)*100;
      const skill=totalAnswered?(totalDifference/totalAnswered):0;
      const popcorn=getPopcornString(accuracy);
      const text=`Runtime Challenge Recap:
Score: ${Math.round(totalScore)}
Accuracy: ${popcorn} (${accuracy.toFixed(1)}%)
Skill: ${skill.toFixed(1)}
Think you can beat me?`;
      const url=`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
      window.open(url,"_blank");
    }
    function copyRecap(){
      const accuracy=(totalCorrect/25)*100;
      const skill=totalAnswered?(totalDifference/totalAnswered):0;
      const popcorn=getPopcornString(accuracy);
      const text=`Runtime Challenge Recap:
Score: ${Math.round(totalScore)}
Accuracy: ${popcorn} (${accuracy.toFixed(1)}%)
Skill: ${skill.toFixed(1)}
Think you can beat me?`;
      navigator.clipboard.writeText(text).then(()=>{
        alert("Recap copied to clipboard!");
      }).catch(()=>{
        alert("Failed to copy recap. Your browser may not allow clipboard writes.");
      });
    }

    /*******************************************************
     * UTILS
     *******************************************************/
    function fadeOutCards(cb){
      const mc=document.getElementById("movies-container");
      const rc=document.getElementById("runtimes-container");
      mc.style.opacity="1";
      rc.style.opacity="1";
      mc.offsetHeight;
      mc.style.opacity="0";
      rc.style.opacity="0";
      setTimeout(cb,500);
    }
    function fadeInCards(){
      const mc=document.getElementById("movies-container");
      const rc=document.getElementById("runtimes-container");
      mc.style.opacity="0";
      rc.style.opacity="0";
      mc.offsetHeight;
      mc.style.opacity="1";
      rc.style.opacity="1";
    }
    function shuffle(array){
      for(let i=array.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [array[i],array[j]]=[array[j],array[i]];
      }
      return array;
    }
    function getPopcornString(accuracyPercent){
      return renderPopcorn(accuracyPercent).trim();
    }
    function renderPopcorn(accuracyPercent){
      const ratingOutOf5=(accuracyPercent/100)*5;
      const full=Math.floor(ratingOutOf5);
      const frac=ratingOutOf5-full;
      let html="";
      for(let i=0;i<full;i++){
        html+="üçø";
      }
      if(frac>0){
        html+="üçø";
      }
      return html+" ";
    }

    // A flexible findMovieCard that tries ignoring trailing " (YYYY)" in alt text
    function findMovieCard(name){
      const cards=document.querySelectorAll("#movies-container .movie-card");
      // e.g. "The Rock" vs alt="The Rock (1996) poster"
      // We'll strip out trailing " (xxxx)" from the alt if present
      const normName = name.trim().toLowerCase();
      for(let c of cards){
        const poster=c.querySelector("img.movie-poster");
        if(poster){
          let altText=poster.alt||"";
          altText=altText.replace(/\s*poster$/i,"").trim().toLowerCase();
          // remove trailing " (xxxx)" if any
          altText=altText.replace(/\(\d{4}\)$/,"").trim();
          if(altText===normName) return c;
        }
      }
      return null;
    }

    function updateGameStatsBox(){
      const statsBox=document.getElementById("this-game-stats");
      statsBox.innerText=`Score: ${Math.round(totalScore)}`;
      if(statsBox.classList.contains("empty")){
        statsBox.classList.remove("empty");
      }
    }
    function randomFrom(arr){
      if(!arr||arr.length===0)return"";
      return arr[Math.floor(Math.random()*arr.length)];
    }
  </script>
</body>
