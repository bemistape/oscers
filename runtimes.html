<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stump the Buff - v4.8</title>
  <style>
    /* ---------- GLOBAL / LAYOUT ---------- */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: black;
      color: white;
      font-family: Rockwell, serif;
    }
    .page-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
      text-align: center;
    }
    h1, h2, h3, p {
      margin: 0 0 10px 0;
    }
    button {
      cursor: pointer;
    }
    .version-number {
      text-align: center;
      font-size: 10px;
      opacity: 0.7;
      margin-top: 20px;
    }

    /* ---------- BUTTON STYLES ---------- */
    .game-btn {
      font-size: 22px;
      padding: 12px 30px;
      margin: 10px 5px;
      background: #FFD700;
      color: black;
      border: none;
      transition: background 0.2s;
    }
    .game-btn:hover {
      background: #FFC700;
    }

    .diff-btn {
      background: #222;
      border: 2px solid #FFD700;
      color: white;
      font-size: 16px;
      padding: 8px 16px;
      margin: 5px;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
    }
    .diff-btn:hover {
      background: #333;
    }
    .diff-btn.active {
      background: #FFD700;
      color: black;
      border-color: #FFD700;
    }

    /* ---------- MAIN CONTAINERS ---------- */
    #intro-container {
      display: flex;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
    }
    #game-container,
    #bonus-container,
    #final-container {
      display: none;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
    }

    /* ---------- INTRO PAGE ---------- */
    #intro-container .intro-rules {
      max-width: 600px;
      font-size: 16px;
      line-height: 1.4;
      margin-bottom: 20px;
      text-align: center;
    }
    .difficulty-box { margin-bottom: 20px; }

    /* ---------- GAME PAGE ---------- */
    #timer-box {
      margin: 10px auto;
      width: 160px;
      height: 160px;
      background-color: #222;
      border-radius: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      border: 2px solid #444;
      transition: all 0.2s ease;
      position: relative;
    }
    /* Round name above the countdown */
    #round-label {
      font-size: 16px;
      opacity: 0.9;
      margin-bottom: 0px;
    }
    #timer-value {
      font-size: 64px;
    }
    #joker-btn {
      position: absolute;
      bottom: 8px;
      width: 48px;
      height: 48px;
      border-radius: 24px;
      font-size: 24px;
      background: #222;
      border: 2px solid #FFD700;
      color: white;
      z-index: 3;
    }
    #joker-btn:hover {
      background: #333;
    }

    #runtimes-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    #movies-container {
      display: grid;
      grid-template-columns: repeat(5, 160px);
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      width: 100%;
    }
    #submit-btn {
      margin-top: 20px;
    }

    .movie-card {
      width: 160px;
      border: 2px solid white;
      padding: 10px;
      background-color: #000;
      border-radius: 15px;
      text-align: center;
      min-height: 220px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      transition: background-color 0.2s, border-color 0.2s;
      cursor: default;
    }
    .movie-card:hover {
      background-color: #111;
    }
    .movie-poster {
      width: 140px;
      height: auto;
      margin-bottom: 5px;
      border-radius: 6px;
    }
    .placed {
      border-color: #FFD700 !important;
      background-color: #111;
    }
    .runtime-card {
      width: 80px;
      height: 50px;
      border-radius: 25px;
      background-color: #FFD700;
      color: black;
      font-weight: bold;
      border: 2px solid #FFD700;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 5px;
      cursor: grab;
      animation: float-run 3s ease-in-out infinite alternate;
      font-size: 14px;
    }
    .runtime-card.dragging {
      outline: 3px solid #fffd00;
      box-shadow: 0 0 10px #fffd00;
    }
    .runtime-card.selected {
      outline: 3px solid #fffd00;
      box-shadow: 0 0 10px #fffd00;
    }
    @keyframes float-run {
      0% { transform: translateY(0); }
      100% { transform: translateY(-5px); }
    }
    .correct {
      background-color: #003300 !important;
      border-color: #00FF00 !important;
      animation: bounce-correct 0.5s;
    }
    .incorrect {
      background-color: #330000 !important;
      border-color: #FF0000 !important;
      animation: shake-red 0.5s;
    }
    @keyframes bounce-correct {
      0% { transform: scale(1); }
      30% { transform: scale(1.1); }
      50% { transform: scale(0.95); }
      100% { transform: scale(1); }
    }
    @keyframes shake-red {
      20% { transform: translateX(-3px); }
      40% { transform: translateX(3px); }
      60% { transform: translateX(-3px); }
      80% { transform: translateX(3px); }
    }
    .stats-box {
      border: 1px solid #666;
      padding: 10px;
      margin: 10px auto;
      width: fit-content;
      min-width: 200px;
    }
    .stats-box.empty { display: none; }

    .glow-anim {
      animation: glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow {
      0% { box-shadow: 0 0 5px #FFD700; }
      100% { box-shadow: 0 0 20px #FFD700; }
    }

    /* ---------- BONUS ROUND (Grid) ---------- */
    #bonus-container {
      text-align: center;
    }
    #bonus-floating-container {
      display: none;
      grid-template-columns: repeat(5, 140px);
      gap: 10px;
      width: 100%;
      max-width: 800px;
      margin: 0 auto 20px auto;
      justify-content: center;
    }
    #bonus-timer-box {
      margin: 10px auto;
      width: 120px;
      height: 120px;
      background-color: #222;
      border-radius: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      font-weight: bold;
      color: white;
      border: 2px solid #444;
      transition: all 0.2s ease;
      margin-bottom: 20px;
    }
    .floating-card {
      width: 140px;
      border: 2px solid white;
      border-radius: 10px;
      background: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      cursor: pointer;
      text-align: center;
    }
    .floating-card:hover {
      background: #111;
    }
    .bonus-poster {
      width: 120px;
      border-radius: 6px;
      margin-bottom: 5px;
    }
    .bonus-runtime {
      font-size: 12px;
      margin-top: 3px;
      display: none;
    }

    /* ---------- FINAL PAGE ---------- */
    #final-container {
      text-align: center;
    }
    #final-scores {
      margin-bottom: 20px;
      font-size: 28px;
      font-weight: bold;
    }
    #final-overall-box {
      border: 1px solid #FFD700;
      padding: 10px;
      margin: 10px auto;
      width: fit-content;
    }
    .final-buttons {
      margin-bottom: 20px;
    }
    .final-round-wrapper {
      border: 2px solid #666;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 20px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
      background: #111;
    }
    .final-round-heading {
      font-size: 20px;
      margin-bottom: 10px;
      text-transform: uppercase;
      font-weight: bold;
      text-align: center;
    }
    .final-round-row {
      display: grid; 
      grid-template-columns: repeat(5, 160px);
      gap: 10px;
      justify-content: center;
      margin-bottom: 15px;
      width: 100%;
    }
    .final-card {
      border-radius: 10px;
      border: 2px solid #666;
      padding: 10px;
      text-align: center;
      background: #000;
      margin: 5px;
      min-height: 220px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }
    .final-card.correct {
      background-color: #003300;
      border-color: #0f0;
    }
    .final-card.incorrect {
      background-color: #330000;
      border-color: #f00;
    }
    .final-card .movie-title {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 5px;
    }
    .final-card .movie-poster {
      width: 140px;
      border-radius: 6px;
      margin-bottom: 5px;
    }
    .round-breakdown-info {
      text-align: center;
      margin-top: 5px;
    }

    /* ---------- REACTION OVERLAY (new) ---------- */
    #reaction-overlay {
      display: none;
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -30%);
      background: rgba(0, 0, 0, 0.95);
      padding: 30px;
      border: 3px solid #00FFFF;
      border-radius: 10px;
      z-index: 99999;
      width: 80%;
      max-width: 400px;
    }
    #reaction-overlay p {
      font-family: "Brush Script MT", cursive, sans-serif;
      font-size: 24px;
      margin-bottom: 20px;
    }
    #reaction-overlay button {
      font-size: 18px;
      padding: 8px 16px;
      background: #FFD700;
      color: black;
      border: none;
      transition: background 0.2s;
    }
    #reaction-overlay button:hover {
      background: #FFC700;
    }

    /* ---------- MINI-RECAP (per-round) ---------- */
    #round-recap-overlay {
      display: none;
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      padding: 20px;
      border: 3px solid #FFD700;
      border-radius: 10px;
      text-align: center;
      z-index: 9999;
      width: 300px;
    }
    #round-recap-overlay h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    #round-recap-overlay p {
      margin-bottom: 10px;
    }

    /* ---------- MEDIA QUERIES for MOBILE ---------- */
    @media (max-width: 600px) {
      #movies-container {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
      .movie-card {
        width: auto;
        min-width: 120px;
      }
      .movie-poster {
        width: 100px;
      }
      #bonus-floating-container {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
      .floating-card {
        width: auto;
        min-width: 100px;
      }
      .bonus-poster {
        width: 80px;
      }
      .final-round-row {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
      .final-card {
        width: auto;
        min-width: 120px;
      }
      .final-card .movie-poster {
        width: 100px;
      }
    }
  </style>
</head>
<body>
  <!-- SOUND EFFECTS -->
  <audio id="ding-sound" src="data:audio/wav;base64,UklGRgAAAABXQVZFZm10IBIAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA="></audio>
  <audio id="buzz-sound" src="data:audio/wav;base64,UklGRgAAAABXQVZFZm10IBIAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA="></audio>
  <!-- AUDIO FOR JOKER -->
  <audio id="joker-sound" preload="auto">
    <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=" type="audio/wav">
  </audio>

  <!-- INTRO SCREEN -->
  <div id="intro-container" class="page-container">
    <h1>Stump the Buff</h1>
    <div class="intro-rules">
      <p>In this game, you'll be given 5 movies each round.</p>
      <p>Drag the runtime card to the movie you think it belongs to.</p>
      <p>You have a limited time each round and can submit early for a time bonus.</p>
      <p>Use your <strong>Joker</strong> once at the start of the round.</p>
    </div>
    <div class="difficulty-box">
      <label style="font-size:16px; margin-right:10px;">Difficulty:</label>
      <button class="diff-btn" data-difficulty="easy" id="easy-btn">Easy</button>
      <button class="diff-btn" data-difficulty="medium" id="medium-btn">Medium</button>
      <button class="diff-btn" data-difficulty="hard" id="hard-btn">Hard</button>
    </div>
    <button id="begin-btn" class="game-btn" disabled>Begin</button>
    <div class="version-number">v4.8</div>
  </div>

  <!-- ROUND RECAP OVERLAY -->
  <div id="round-recap-overlay">
    <h3 id="round-recap-title"></h3>
    <p id="round-recap-details"></p>
    <button id="round-recap-close-btn" class="game-btn" style="font-size:16px; padding:6px 12px;">OK</button>
  </div>

  <!-- REACTION OVERLAY -->
  <div id="reaction-overlay">
    <p id="reaction-quote"></p>
    <button id="reaction-close-btn" class="game-btn">OK</button>
  </div>

  <!-- GAME SCREEN -->
  <div id="game-container" class="page-container">
    <div id="timer-box">
      <div id="round-label">Round 1</div>
      <div id="timer-value">20</div>
      <button id="joker-btn" class="glow-anim" title="Reveal relative runtimes briefly">ü§°</button>
    </div>
    <div id="runtimes-container" class="cards-container"></div>
    <div id="movies-container" class="cards-container"></div>
    <button id="submit-btn" class="game-btn" title="Submit early to earn extra time bonus!">Submit</button>
    <div id="this-game-stats" class="stats-box empty"></div>
  </div>

  <!-- BONUS ROUND (Grid Layout) -->
  <div id="bonus-container" class="page-container">
    <div id="bonus-intro" style="max-width:600px; margin-bottom:20px;">
      <p><strong>Bonus Round!</strong> Pick which movie has the longest runtime for +1000 points. 
         You have a short time, so choose quickly!</p>
      <button id="bonus-begin-btn" class="game-btn">Begin Bonus</button>
    </div>
    <div id="bonus-timer-box" style="display:none;"><span id="bonus-timer-value">10</span></div>
    <h3 id="bonus-message"></h3>
    <div id="bonus-floating-container"></div>
    <button id="bonus-continue-btn" class="game-btn" style="display:none;">Continue</button>
    <div id="bonus-result"></div>
  </div>

  <!-- FINAL SCREEN -->
  <div id="final-container" class="page-container">
    <div id="final-scores"></div>
    <div id="final-overall-box"></div>
    <div class="final-buttons">
      <button id="share-twitter-btn" class="game-btn">Share on Twitter</button>
      <button id="copy-recap-btn" class="game-btn">Copy Recap</button>
      <button id="play-again-btn" class="game-btn">Play Again?</button>
    </div>
    <div id="details-container">
      <div id="final-cards-container"></div>
    </div>
  </div>

  <script>
    /*******************************************************
     * GLOBAL STATE & CONFIG
     *******************************************************/
    const csvUrl = "runtime_source_02222025.csv";
    const reactionsUrl = "reactions.csv";

    let difficulty;
    let allMovies = [];
    let filteredMovies = [];

    // Reaction arrays
    let perfectReactions = [];
    let closeReactions = [];
    let unimpressedReactions = [];
    let badReactions = [];

    const TIMERS = {
      easy:   [30, 30, 30, 30, 30],
      medium: [30, 25, 20, 15, 15],
      hard:   [20, 18, 15, 12, 10]
    };
    let roundTimers = [];
    let rounds = [];
    let currentRoundIndex = 0;

    let totalCorrect = 0;
    let totalDifference = 0;
    let totalAnswered = 0;
    let totalScore = 0;
    let roundScores = [];

    let jokerUsed = false;
    let timeLeft = 20;
    let roundTimer = null;
    let canDrag = false;

    // For mobile fallback: selected runtime card
    let selectedRuntimeCard = null;

    // Bonus
    let bonusMovies = [];
    let bonusUsed = false;
    let bonusTimer = null;
    let bonusTimeLeft = 10;
    let bonusStarted = false;

    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("easy-btn").addEventListener("click", () => setDifficulty("easy"));
      document.getElementById("medium-btn").addEventListener("click", () => setDifficulty("medium"));
      document.getElementById("hard-btn").addEventListener("click", () => setDifficulty("hard"));
      setDifficulty("easy");

      const beginBtn = document.getElementById("begin-btn");
      beginBtn.disabled = true;
      beginBtn.innerText = "Loading...";

      try {
        await fetchMainCSV();
        await fetchReactionsCSV();
        beginBtn.disabled = false;
        beginBtn.innerText = "Begin";
      } catch(e) {
        console.error("Error loading data:", e);
        beginBtn.innerText = "Error loading data";
      }

      beginBtn.addEventListener("click", onBeginGame);

      document.getElementById("joker-btn").addEventListener("click", () => {
        if (!jokerUsed) useJoker();
      });
      document.getElementById("submit-btn").addEventListener("click", onSubmitRound);

      document.getElementById("bonus-begin-btn").addEventListener("click", startBonusActual);
      document.getElementById("bonus-continue-btn").addEventListener("click", onFinishBonus);

      document.getElementById("share-twitter-btn").addEventListener("click", shareOnTwitter);
      document.getElementById("copy-recap-btn").addEventListener("click", copyRecap);
      document.getElementById("play-again-btn").addEventListener("click", () => {
        document.getElementById("final-container").style.display = "none";
        document.getElementById("intro-container").style.display = "flex";
      });

      document.getElementById("round-recap-close-btn").addEventListener("click", () => {
        document.getElementById("round-recap-overlay").style.display = "none";
        // After closing the round recap, show the reaction overlay.
        showReactionOverlay(pendingReaction);
      });

      document.getElementById("reaction-close-btn").addEventListener("click", () => {
        document.getElementById("reaction-overlay").style.display = "none";
        nextRoundAfterReaction();
      });
    });

    /*******************************************************
     * CSV LOADING (Main + Reactions)
     *******************************************************/
    async function fetchMainCSV() {
      const resp = await fetch(csvUrl);
      let data = await resp.text();
      data = data.replace(/^\uFEFF/, "");
      parseMainCSV(data);
    }
    function parseMainCSV(csvData) {
      const lines = csvData.trim().split(/\r?\n/);
      const headers = lines[0].split(",");
      const colMovieName = headers.indexOf("movie_name");
      const colRuntime = headers.indexOf("runtime");
      const colDifficulty = headers.indexOf("difficulty");
      const colGroup = headers.indexOf("group");
      const colPoster = headers.indexOf("poster");
      const colOverview = headers.indexOf("overview");

      for (let i = 1; i < lines.length; i++) {
        const rowCells = lines[i].split(",");
        if (rowCells.length < 6) continue;
        let movie = {};
        movie.movie_name = rowCells[colMovieName]?.trim() || "";
        movie.runtime = parseInt(rowCells[colRuntime] || "0", 10);
        movie.difficulty = rowCells[colDifficulty]?.trim().toLowerCase() || "";
        movie.group = rowCells[colGroup]?.trim().toUpperCase() || "";
        movie.poster = rowCells[colPoster]?.trim() || "";
        movie.overview = rowCells[colOverview]?.trim() || "";
        movie._assignedRuntime = null;
        allMovies.push(movie);
      }
    }

    async function fetchReactionsCSV(){
      const resp = await fetch(reactionsUrl);
      let data = await resp.text();
      data = data.replace(/^\uFEFF/, "");
      parseReactionsCSV(data);
    }
    function parseReactionsCSV(csvData){
      const rows = parseCSVWithQuotes(csvData);
      const headers = rows[0];
      const colPerfect = headers.indexOf("perfect");
      const colClose = headers.indexOf("close");
      const colUnimp = headers.indexOf("unimpressed");
      const colBad = headers.indexOf("bad");
      for(let i=1; i<rows.length; i++){
        const r = rows[i];
        if(r.length < 4) continue;
        if(r[colPerfect]) perfectReactions.push(r[colPerfect]);
        if(r[colClose]) closeReactions.push(r[colClose]);
        if(r[colUnimp]) unimpressedReactions.push(r[colUnimp]);
        if(r[colBad]) badReactions.push(r[colBad]);
      }
    }
    function parseCSVWithQuotes(csv){
      const lines = [];
      let currentLine = [];
      let currentCell = "";
      let inQuotes = false;
      for(let i=0; i<csv.length; i++){
        const c = csv[i];
        if(c === '"'){
          if(inQuotes && csv[i+1] === '"'){
            currentCell += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if(c === ',' && !inQuotes){
          currentLine.push(currentCell);
          currentCell = "";
        } else if((c === '\r' || c === '\n') && !inQuotes){
          if(c === '\r' && i < csv.length - 1 && csv[i+1] === '\n'){
            i++;
          }
          currentLine.push(currentCell);
          lines.push(currentLine);
          currentLine = [];
          currentCell = "";
        } else {
          currentCell += c;
        }
      }
      if(currentCell || currentLine.length > 0){
        currentLine.push(currentCell);
        lines.push(currentLine);
      }
      return lines;
    }

    /*******************************************************
     * DIFFICULTY / SETUP
     *******************************************************/
    function setDifficulty(diff) {
      difficulty = diff;
      ["easy-btn", "medium-btn", "hard-btn"].forEach(id => {
        document.getElementById(id).classList.remove("active");
      });
      document.getElementById(`${diff}-btn`).classList.add("active");
    }
    function onBeginGame() {
      if (!difficulty) difficulty = "easy";
      document.getElementById("intro-container").style.display = "none";
      document.getElementById("game-container").style.display = "flex";
      setupGame();
    }
    function setupGame() {
      currentRoundIndex = 0;
      totalCorrect = 0;
      totalDifference = 0;
      totalAnswered = 0;
      totalScore = 0;
      roundScores = [];
      jokerUsed = false;
      bonusUsed = false;
      bonusStarted = false;
      selectedRuntimeCard = null;

      document.getElementById("bonus-container").style.display = "none";
      document.getElementById("final-container").style.display = "none";

      filterByDifficulty();
      if(filteredMovies.length < 5){
        filteredMovies = allMovies.slice();
      }
      roundTimers = TIMERS[difficulty] || [20, 20, 20, 20, 20];
      buildRounds();
      startRound();
    }
    function filterByDifficulty() {
      if(!difficulty) return;
      filteredMovies = allMovies.filter(m => m.difficulty === difficulty);
    }
    function buildRounds(){
      const groups = { A: [], B: [], C: [], D: [], E: [] };
      filteredMovies.forEach(movie => {
        if(groups[movie.group] !== undefined){
          groups[movie.group].push(movie);
        }
      });
      for(let g in groups){
        groups[g] = shuffle(groups[g]);
      }
      const potentialRoundsCount = Math.min(
        groups["A"].length,
        groups["B"].length,
        groups["C"].length,
        groups["D"].length,
        groups["E"].length
      );
      const finalCount = Math.min(potentialRoundsCount, 5);
      rounds = [];
      for(let i = 0; i < finalCount; i++){
        rounds.push([
          groups["A"][i],
          groups["B"][i],
          groups["C"][i],
          groups["D"][i],
          groups["E"][i]
        ]);
      }
      console.log("Rounds built:", rounds);
    }

    /*******************************************************
     * ROUND LOGIC
     *******************************************************/
    function startRound(){
      if(currentRoundIndex >= 5){
        document.getElementById("game-container").style.display = "none";
        document.getElementById("bonus-container").style.display = "flex";
        document.getElementById("bonus-intro").style.display = "block";
        document.getElementById("bonus-timer-box").style.display = "none";
        document.getElementById("bonus-floating-container").style.display = "none";
        document.getElementById("bonus-continue-btn").style.display = "none";
        return;
      }
      fadeOutCards(() => {
        renderRound();
        fadeInCards();
      });
    }
    function renderRound(){
      timeLeft = roundTimers[currentRoundIndex] || 20;
      setupTimer();
      updateGameStatsBox();

      document.getElementById("round-label").innerText = `Round ${currentRoundIndex+1}`;

      const moviesContainer = document.getElementById("movies-container");
      const runtimesContainer = document.getElementById("runtimes-container");
      moviesContainer.innerHTML = "";
      runtimesContainer.innerHTML = "";

      document.getElementById("joker-btn").style.display = jokerUsed ? "none" : "inline-block";

      const roundMovies = rounds[currentRoundIndex];
      // Shuffle the movie order for display
      const displayMovies = shuffle([...roundMovies]);
      displayMovies.forEach(m => {
        const card = document.createElement("div");
        card.classList.add("movie-card");
        card.setAttribute("data-correct", m.runtime);
        card.movie = m;
        let posterHTML = m.poster ? `<img class="movie-poster" src="${m.poster}" alt="${m.movie_name} poster">` : "";
        // Omit title text for round display
        card.innerHTML = posterHTML;
        card.addEventListener("click", function(e){
          if(selectedRuntimeCard && !card.querySelector(".runtime-card")){
            card.appendChild(selectedRuntimeCard);
            card.classList.add("placed");
            m._assignedRuntime = parseInt(selectedRuntimeCard.getAttribute("data-runtime"), 10);
            selectedRuntimeCard.classList.remove("selected");
            selectedRuntimeCard = null;
          }
        });
        card.addEventListener("dragover", e => { if(canDrag) e.preventDefault(); });
        card.addEventListener("drop", e => dropHandler(e, m, card));
        moviesContainer.appendChild(card);
      });

      // Render runtime cards with tap-to-select fallback
      roundMovies.forEach((m, i) => {
        const rc = document.createElement("div");
        rc.classList.add("runtime-card");
        rc.setAttribute("data-unique", `rt-${currentRoundIndex}-${i}`);
        rc.setAttribute("data-runtime", m.runtime.toString());
        rc.innerText = m.runtime + " min";
        rc.setAttribute("draggable", "true");
        rc.addEventListener("dragstart", e => {
          if(!canDrag){ e.preventDefault(); return; }
          rc.classList.add("dragging");
          e.dataTransfer.setData("text/plain", rc.getAttribute("data-unique"));
        });
        rc.addEventListener("dragend", e => {
          rc.classList.remove("dragging");
        });
        rc.addEventListener("click", function(e){
          if(selectedRuntimeCard === rc){
            rc.classList.remove("selected");
            selectedRuntimeCard = null;
          } else {
            if(selectedRuntimeCard) {
              selectedRuntimeCard.classList.remove("selected");
            }
            selectedRuntimeCard = rc;
            rc.classList.add("selected");
          }
        });
        runtimesContainer.appendChild(rc);
      });
      canDrag = true;
    }

    function setupTimer(){
      clearInterval(roundTimer);
      styleTimerBox(timeLeft);
      const timerVal = document.getElementById("timer-value");
      timerVal.innerText = timeLeft;

      roundTimer = setInterval(() => {
        timeLeft--;
        timerVal.innerText = timeLeft;
        styleTimerBox(timeLeft);
        if(timeLeft <= 0){
          clearInterval(roundTimer);
          onSubmitRound();
        }
      }, 1000);
    }
    function styleTimerBox(t){
      const timerBox = document.getElementById("timer-box");
      if(t <= 3){
        timerBox.style.color = "red";
        timerBox.style.borderColor = "red";
      } else if(t <= 5){
        timerBox.style.color = "orange";
        timerBox.style.borderColor = "orange";
      } else if(t <= 10){
        timerBox.style.color = "yellow";
        timerBox.style.borderColor = "yellow";
      } else {
        timerBox.style.color = "white";
        timerBox.style.borderColor = "#444";
      }
    }

    function dropHandler(e, movieObj, movieCard){
      if(!canDrag)return;
      e.preventDefault();
      const uniqueId = e.dataTransfer.getData("text/plain");
      const dragged = document.querySelector(`.runtime-card[data-unique="${uniqueId}"]`);
      if(!dragged)return;
      const rc = document.getElementById("runtimes-container");
      const existing = movieCard.querySelector(".runtime-card");
      if(existing) rc.appendChild(existing);
      movieCard.appendChild(dragged);
      movieCard.classList.add("placed");
      movieObj._assignedRuntime = parseInt(dragged.getAttribute("data-runtime"), 10);
    }

    function onSubmitRound(){
      clearInterval(roundTimer);
      canDrag = false;
      document.getElementById("submit-btn").style.display = "none";

      const roundMovies = rounds[currentRoundIndex];
      let roundCorrect = 0;
      let roundDiff = 0;
      let answeredCount = 0;
      let sumActual = 0;

      const cards = document.getElementById("movies-container").children;
      for(let i = 0; i < cards.length; i++){
        const card = cards[i];
        const correctRuntime = parseInt(card.getAttribute("data-correct"), 10);
        sumActual += correctRuntime;
        const assigned = card.querySelector(".runtime-card");
        if(assigned){
          answeredCount++;
          const userRuntime = parseInt(assigned.getAttribute("data-runtime"), 10);
          if(userRuntime === correctRuntime){
            roundCorrect++;
            card.classList.add("correct");
          } else {
            card.classList.add("incorrect");
            showCorrectLine(card, correctRuntime);
          }
        } else {
          card.classList.add("incorrect");
          showCorrectLine(card, correctRuntime);
        }
      }

      const leftoverBonus = timeLeft * 10;
      roundMovies.forEach(m => {
        if(m._assignedRuntime != null){
          roundDiff += Math.abs(m._assignedRuntime - m.runtime);
        }
      });

      let fractionBonus = 0;
      if(answeredCount === 5){
        const avgActual = sumActual / 5;
        const avgDiff = roundDiff / answeredCount;
        const fraction = avgDiff / avgActual;
        fractionBonus = (1000 * roundCorrect) * Math.pow((1 - fraction), 2);
      }

      const baseScore = roundCorrect * 1000;
      const roundScore = baseScore + leftoverBonus + fractionBonus;

      totalCorrect += roundCorrect;
      totalDifference += roundDiff;
      totalAnswered += answeredCount;
      totalScore += roundScore;

      roundScores.push({
        roundIndex: currentRoundIndex+1,
        correct: roundCorrect,
        diff: roundDiff,
        answered: answeredCount,
        leftoverBonus: leftoverBonus,
        fractionBonus: fractionBonus,
        roundScore: roundScore
      });

      // Determine reaction based on roundCorrect
      let reactionText = "";
      if(roundCorrect === 5){
        reactionText = randomFrom(perfectReactions);
      } else if(roundCorrect === 4){
        reactionText = randomFrom(closeReactions);
      } else if(roundCorrect === 3 || roundCorrect === 2){
        reactionText = randomFrom(unimpressedReactions);
      } else {
        reactionText = randomFrom(badReactions);
      }
      // Pass reactionText to a separate overlay
      showRoundRecapOverlay(roundCorrect, answeredCount, leftoverBonus, fractionBonus, roundScore);
      // Then, immediately show the reaction overlay over the game board
      setTimeout(() => {
        showReactionOverlay(reactionText);
      }, 500);
    }

    function showCorrectLine(card, correctRuntime){
      const line = document.createElement("div");
      line.style.fontSize = "12px";
      line.style.marginTop = "5px";
      line.innerText = `Correct: ${correctRuntime} min`;
      card.appendChild(line);
    }

    function showRoundRecapOverlay(roundCorrect, answeredCount, leftoverBonus, fractionBonus, roundScore){
      const overlay = document.getElementById("round-recap-overlay");
      const title = document.getElementById("round-recap-title");
      const details = document.getElementById("round-recap-details");
      title.innerText = `Round ${currentRoundIndex+1} Recap`;
      details.innerHTML = `
        Correct: <strong>${roundCorrect}</strong> / 5<br>
        Time bonus: <strong>+${leftoverBonus.toFixed(0)}</strong><br>
        Accuracy bonus: <strong>+${fractionBonus.toFixed(0)}</strong><br>
        Round Score: <strong>${roundScore.toFixed(0)}</strong>
      `;
      overlay.style.display = "block";
    }

    function showReactionOverlay(quoteText){
      const overlay = document.getElementById("reaction-overlay");
      // Enclose in quotes
      document.getElementById("reaction-quote").innerText = `‚Äú${quoteText}‚Äù`;
      overlay.style.display = "block";
    }

    function nextRoundAfterReaction(){
      document.getElementById("reaction-overlay").style.display = "none";
      document.getElementById("submit-btn").style.display = "block";
      currentRoundIndex++;
      startRound();
    }

    /*******************************************************
     * JOKER: REVEAL RELATIVE RUNTIMES
     *******************************************************/
    function useJoker(){
      if(jokerUsed)return;
      jokerUsed = true;
      document.getElementById("joker-btn").style.display = "none";
      const snd = document.getElementById("joker-sound");
      snd.currentTime = 0;
      snd.play().catch(()=>{});
      const roundMovies = rounds[currentRoundIndex];
      const sorted = [...roundMovies].sort((a, b) => b.runtime - a.runtime);
      const greenShades = ["#003300","#006600","#009900","#00CC00","#00FF00"];
      const originals = [];
      sorted.forEach((m, idx) => {
        const card = findMovieCard(m.movie_name);
        if(!card)return;
        originals.push({card: card, bg: card.style.backgroundColor, bc: card.style.borderColor});
        card.style.backgroundColor = greenShades[idx];
        card.style.borderColor = greenShades[idx];
      });
      setTimeout(()=>{
        originals.forEach(o=>{
          o.card.style.backgroundColor = "#000";
          o.card.style.borderColor = "white";
        });
      }, 5000);
    }

    /*******************************************************
     * BONUS ROUND
     *******************************************************/
    function startBonusActual(){
      if(bonusStarted)return;
      bonusStarted = true;
      document.getElementById("bonus-intro").style.display = "none";
      document.getElementById("bonus-timer-box").style.display = "flex";
      document.getElementById("bonus-floating-container").style.display = "grid";
      document.getElementById("bonus-continue-btn").style.display = "none";
      startBonusRound();
    }
    function startBonusRound(){
      bonusUsed = false;
      bonusTimeLeft = 10;
      let pool = shuffle(filteredMovies.slice());
      if(pool.length < 5) pool = allMovies.slice();
      bonusMovies = pool.slice(0, 5);
      const container = document.getElementById("bonus-floating-container");
      container.innerHTML = "";
      bonusMovies.forEach(m => {
        const card = document.createElement("div");
        card.classList.add("floating-card");
        if(m.poster){
          const img = document.createElement("img");
          img.src = m.poster;
          img.classList.add("bonus-poster");
          card.appendChild(img);
        }
        const runtimeLine = document.createElement("div");
        runtimeLine.classList.add("bonus-runtime");
        runtimeLine.innerText = `${m.runtime} min`;
        card.appendChild(runtimeLine);
        card.addEventListener("click", () => pickBonusMovie(m, card));
        container.appendChild(card);
      });
      setupBonusTimer();
      document.getElementById("bonus-message").innerText = "";
      document.getElementById("bonus-result").innerText = "";
    }
    function setupBonusTimer(){
      clearInterval(bonusTimer);
      const box = document.getElementById("bonus-timer-box");
      const val = document.getElementById("bonus-timer-value");
      val.innerText = bonusTimeLeft;
      box.style.color = "white";
      box.style.borderColor = "#444";
      bonusTimer = setInterval(()=>{
        bonusTimeLeft--;
        val.innerText = bonusTimeLeft;
        if(bonusTimeLeft <= 3){
          box.style.color = "red";
          box.style.borderColor = "red";
        } else if(bonusTimeLeft <= 5){
          box.style.color = "orange";
          box.style.borderColor = "orange";
        }
        if(bonusTimeLeft <= 0){
          clearInterval(bonusTimer);
          if(!bonusUsed){
            document.getElementById("bonus-message").innerText = "Time's up! No pick made.";
            document.getElementById("bonus-continue-btn").style.display = "inline-block";
          }
        }
      }, 1000);
    }
    function pickBonusMovie(chosenMovie, chosenCard){
      if(bonusUsed)return;
      bonusUsed = true;
      clearInterval(bonusTimer);
      let maxRuntime = -1, maxMovie = null;
      bonusMovies.forEach(m => {
        if(m.runtime > maxRuntime){
          maxRuntime = m.runtime;
          maxMovie = m;
        }
      });
      const correct = (chosenMovie.runtime === maxRuntime);
      chosenCard.classList.add(correct ? "correct" : "incorrect");
      if(correct){
        totalScore += 1000;
        document.getElementById("bonus-message").innerText = "Correct! +1000 points.";
      } else {
        document.getElementById("bonus-message").innerText = `Sorry, it was ${maxMovie.movie_name} (${maxRuntime} min).`;
      }
      const allCards = document.querySelectorAll("#bonus-floating-container .floating-card");
      allCards.forEach(c => {
        const rt = c.querySelector(".bonus-runtime");
        if(rt) rt.style.display = "block";
      });
      document.getElementById("bonus-continue-btn").style.display = "inline-block";
    }
    function onFinishBonus(){
      document.getElementById("bonus-container").style.display = "none";
      showFinalScreen();
    }

    /*******************************************************
     * FINAL SCREEN
     *******************************************************/
    function showFinalScreen(){
      document.getElementById("final-container").style.display = "flex";
      const accuracy = (totalCorrect / 25) * 100;
      const skill = totalAnswered ? (totalDifference / totalAnswered) : 0;
      document.getElementById("final-scores").innerText = `Final Score: ${Math.round(totalScore)}`;
      const overallBox = document.getElementById("final-overall-box");
      overallBox.innerHTML = `Accuracy: ${accuracy.toFixed(1)}% | Skill: ${skill.toFixed(1)} min`;
      const finalCardsContainer = document.getElementById("final-cards-container");
      finalCardsContainer.innerHTML = "";
      rounds.forEach((round, idx) => {
        const wrapper = document.createElement("div");
        wrapper.classList.add("final-round-wrapper");
        const heading = document.createElement("div");
        heading.classList.add("final-round-heading");
        heading.innerText = `Round ${idx+1}`;
        wrapper.appendChild(heading);
        const rowDiv = document.createElement("div");
        rowDiv.classList.add("final-round-row");
        round.forEach(movie => {
          const actual = movie.runtime;
          const assigned = (movie._assignedRuntime !== null) ? movie._assignedRuntime : "-";
          const isCorrect = (assigned === actual);
          const card = document.createElement("div");
          card.classList.add("final-card");
          if(assigned !== "-"){
            card.classList.add(isCorrect ? "correct" : "incorrect");
          }
          let posterHTML = movie.poster ? `<img class="movie-poster" src="${movie.poster}" alt="${movie.movie_name} poster">` : "";
          card.innerHTML = `
            ${posterHTML}
            <div class="movie-title">${movie.movie_name}</div>
            <div>Actual: ${movie.runtime} min</div>
            <div>Your Pick: ${assigned === "-" ? "-" : assigned + " min"}</div>
          `;
          rowDiv.appendChild(card);
        });
        wrapper.appendChild(rowDiv);
        const roundInfo = roundScores[idx];
        if(roundInfo){
          const infoDiv = document.createElement("div");
          infoDiv.classList.add("round-breakdown-info");
          infoDiv.innerHTML = `
            ${roundInfo.correct}/5 correct<br>
            Time bonus: +${(roundInfo.leftoverBonus || 0).toFixed(0)}<br>
            Accuracy bonus: +${(roundInfo.fractionBonus || 0).toFixed(0)}<br>
            Round Score: ${roundInfo.roundScore.toFixed(0)}
          `;
          wrapper.appendChild(infoDiv);
        }
        finalCardsContainer.appendChild(wrapper);
      });
    }

    /*******************************************************
     * SHARE & COPY
     *******************************************************/
    function shareOnTwitter(){
      const accuracy = (totalCorrect / 25) * 100;
      const skill = totalAnswered ? (totalDifference / totalAnswered) : 0;
      const popcorn = getPopcornString(accuracy);
      const text = `Stump the Buff Recap:
Score: ${Math.round(totalScore)}
Accuracy: ${popcorn} (${accuracy.toFixed(1)}%)
Skill: ${skill.toFixed(1)}
Think you can beat me? Head to oscers.com`;
      const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
      window.open(url, "_blank");
    }
    function copyRecap(){
      const accuracy = (totalCorrect / 25) * 100;
      const skill = totalAnswered ? (totalDifference / totalAnswered) : 0;
      const popcorn = getPopcornString(accuracy);
      const text = `Stump the Buff Recap:
Score: ${Math.round(totalScore)}
Accuracy: ${popcorn} (${accuracy.toFixed(1)}%)
Skill: ${skill.toFixed(1)}
Think you can beat me? Head to oscers.com`;
      navigator.clipboard.writeText(text).then(()=>{
        alert("Recap copied to clipboard!");
      }).catch(()=>{
        alert("Failed to copy recap. Your browser may not allow clipboard writes.");
      });
    }

    /*******************************************************
     * UTILS
     *******************************************************/
    function fadeOutCards(callback){
      const mc = document.getElementById("movies-container");
      const rc = document.getElementById("runtimes-container");
      mc.style.opacity = "1";
      rc.style.opacity = "1";
      mc.offsetHeight;
      mc.style.opacity = "0";
      rc.style.opacity = "0";
      setTimeout(callback, 500);
    }
    function fadeInCards(){
      const mc = document.getElementById("movies-container");
      const rc = document.getElementById("runtimes-container");
      mc.style.opacity = "0";
      rc.style.opacity = "0";
      mc.offsetHeight;
      mc.style.opacity = "1";
      rc.style.opacity = "1";
    }
    function shuffle(array){
      for(let i = array.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
    function getPopcornString(accuracyPercent){
      return renderPopcorn(accuracyPercent).trim();
    }
    function renderPopcorn(accuracyPercent){
      const ratingOutOf5 = (accuracyPercent / 100) * 5;
      const full = Math.floor(ratingOutOf5);
      const frac = ratingOutOf5 - full;
      let html = "";
      for(let i = 0; i < full; i++){
        html += "üçø";
      }
      if(frac > 0){
        html += "üçø";
      }
      return html + " ";
    }
    function findMovieCard(name){
      const cards = document.querySelectorAll("#movies-container .movie-card");
      for(let c of cards){
        const poster = c.querySelector("img.movie-poster");
        if(poster && poster.alt === name + " poster"){
          return c;
        }
      }
      return null;
    }
    function updateGameStatsBox(){
      const statsBox = document.getElementById("this-game-stats");
      statsBox.innerText = `Score: ${Math.round(totalScore)}`;
      if(statsBox.classList.contains("empty")){
        statsBox.classList.remove("empty");
      }
    }
    function randomFrom(arr){
      if(!arr || arr.length === 0) return "";
      return arr[Math.floor(Math.random() * arr.length)];
    }
  </script>
</body>
</html>
